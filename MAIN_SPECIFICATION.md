# Специфікація системи збору наукових даних про інгредієнти БАДів

## Мета

Створити надійну систему збору наукових даних про інгредієнти БАДів із жорсткою політикою джерел, валідацією цитат і відсутністю галюцинацій. Вихід: структурований JSON + людиночитне резюме українською.

---

## Ключові принципи

1. **Нуль галюцинацій**: жодних даних без URL/PMID/DOI і дослівної англ. цитати.
2. **Пріоритет джерел** (source\_priority):

   * **L1 (найвищий)**: PubMed/NIH (pubmed.ncbi.nlm.nih.gov, ncbi.nlm.nih.gov), EFSA, EMA, FDA (CDER/DSHEA guidance), USP/Ph.Eur., WHO monographs, ODS (ods.od.nih.gov), **Wikipedia** (uk.wikipedia.org, en.wikipedia.org).
   * **L2**: авторитетні рецензовані журнали (Nature, Science, Wiley, Elsevier, MDPI, Springer, Oxford, Cambridge) — напряму з видавця з DOI.
   * **L3**: систематичні огляди/метааналізи, наукові огляди з імпакт‑фактором (через видавця/DOI).
   * **L4 (fallback)**: інші наукові репозитарії (ResearchGate — тільки як дубль із DOI, якщо оригінал недоступний), університетські сайти, книжкові монографії з ISBN (обмежено), Wikidata.
   * Блогу/маркетингових сайтів — **заборонено**.
3. **Простота**: якщо нема надійних джерел L1-L2 → пишемо "немає даних". Ніяких черг для людського перегляду.
4. **Повторюваність**: чіткі підзадачі (агенти), перевірки та логи.

---

## Цільовий JSON Schema (скорочено)

```json
{
  "ingredient": "string",
  "taxon": { "uk": "string", "lat": "string", "rank": "species|genus|other" },
  "source_material": {
    "kingdom": "Рослини|Тварини|Гриби|Бактерії|Людина|Інше",
    "part_or_origin": "string",
    "notes": "string|null"
  },
  "active_compounds": [
    {
      "name": "string",
      "evidence": [{
        "url": "string",
        "doi": "string|null",
        "pmid": "string|null",
        "quote_en": "string",
        "source_priority": 1
      }]
    }
  ],
  "daily_dose": {
    "statement": "string|null",
    "unit": "mg|µg|IU|CFU|g|ml|units|other|null",
    "context": "adult|pregnant|pediatric|general|null",
    "evidence": [{ "url": "string", "doi": "string|null", "pmid": "string|null", "quote_en": "string", "source_priority": 1 }]
  },
  "probiotic": {
    "strain": "e.g., Lactobacillus rhamnosus GG (ATCC 53103)|null",
    "cfu_formulation": "e.g., ≥1×10^9 CFU/day|null"
  },
  "class_overrides": {
    "vitamin_form": "холекальциферол|цианкобаламін|null",
    "mineral_form": "цинку піколінат|null",
    "enzyme_origin": "мікробна ферментація|тваринне походження|null"
  },
  "result_status": "complete|partial|no_data",
  "log": { "search_terms": ["..."], "time": "ISO8601", "notes": "..." }
}
```

---

## Пайплайн (етапи 0–9)

**0. Нормалізація вхідної назви**

* Детектуємо категорію: рослина/тварина/вітамін/мінерал/фермент/пробіотик/інші.
* Якщо рослина: знаходити латинський біноміал (наприклад, *Curcuma longa*). Якщо тваринне: *Haliotis spp.*; якщо пробіотик — штам.
* Виводимо `taxon` і `source_material.kingdom` попередньо.

**1. Пошук (агент Searcher)**

* Генеруємо орієнтовні запити: `<ingredient> site:ncbi.nlm.nih.gov`, `"<latin>" dose site:efsa.europa.eu`, `"<latin>" active compounds DOI` тощо.
* Збираємо кандидати URL і метадані (title, publisher, year, DOI/PMID).
* Фільтр за білим списком доменів/регекс DOI/PMID.

**2. Рангування джерел**

* Присвоюємо `source_priority` за правилами L1–L4.
* Відкидаємо дублі (той самий DOI/PMID).

**3. Суддя (агент Judge)**

* Перевіряє, чи кожне посилання дійсне, не огляд без цитат, не блог, має DOI/PMID або офіційний реєстр (EFSA/FDA/USP).
* Маркує невідповідні як `reject_reason` (лог).

**4. Екстрактор (агент Extractor)**

* Витягає рівно три блоки: **походження**, **активні сполуки**, **добова норма**.
* Для кожного твердження обов'язково: дослівна англ. цитата `quote_en` + `url` + `DOI/PMID` (якщо є) + `source_priority`.

**5. Валідація (агент Validator)**

* Регекси:

  * DOI: `10\.\d{4,9}/[-._;()/:A-Z0-9]+` (case‑insensitive)
  * PMID: `^\d{5,9}
  * URL: https + домен із білого списку.
* Перевірки: узгодженість одиниць (µg vs mcg), діапазони, CFU формат, латинь у курсиві для рендеру.

**6. Простий підхід до конфліктів**

* Якщо дані суперечливі → береми перше надійне джерело L1-L2
* Якщо є тільки L3/L4 → пишемо "немає даних"

**7. Форматування українською (агент Formatter)**

* Правила відображення:

  * **Назва**: `[Назва українською] (Оригінальна латинська/англійська назва)`.
  * **Джерело**: `[вид українською] ([латинська назва]); [частина/тип сировини]`.
  * Пробіотики: `[штам] (лат/англ); культура мікроорганізмів`.
  * Вітаміни/мінерали: форма речовини; зазначити «синтетичного походження», якщо релевантно.

**8. Вивід (дві форми)**

* **A. JSON (машиночитне)** за Schema вище.
* **B. Людиночитне резюме** строго у 6‑блоковому форматі (UA), зі **заповненими посиланнями і цитатами**, або `немає даних` тільки якщо **всіх L1–L4 немає**.

**9. Збереження + індексація**

* Запис до Google Sheets/BigQuery; зберігання сирих логів пошуку + версійність (`changelog.md`), прогрес (`progress.md`).

---

## Жорстка політика «Немає даних»

* Дозволено ставити `немає даних` **лише** якщо:

  * пошук пройшов по L1→L4,
  * немає валідних URL/PMID/DOI,
  * лог містить фактичні спроби пошуку (терміни, домени).
* Інакше — **повернутися на Етап 1** або встановити `needs_human_review`.

---

## Специфіка категорій

* **Пробіотики**: обов'язково штам (ATCC/DSM тощо), CFU/добу; первинні клін. дослідження/монографії.
* **Вітаміни/Мінерали**: UL/AI/RDA з ODS/EFSA; вказати форму (наприклад, «цинку піколінат»).
* **Ферменти**: вказати «мікробна ферментація» або «тваринне походження».
* **Тваринні джерела (напр., Abalone)**: таксон (*Haliotis spp.*), «цілий організм/екстракт», алергени, застереження.

---

## Правила форматування UA

* Назва: `[Українська] (лат/англ)`.
* Джерело: `[вид укр] ([лат]); [частина/тип сировини]`.
* Прикладами для `частина/тип`: "кореневище", "листя", "цілий організм", "екстракт", "культура мікроорганізмів", "мікробна ферментація", "хімічний синтез", "біотехнологічний синтез", "синтетичного походження", "людського походження".
* Курсив латинської у рендері (за потреби UI).
* Одиниці: µg (не mcg); діапазони «500–1000 мг/день» (довге тире).

---

## Каскадна логіка джерел

* **Пріоритет:** спочатку шукаємо L1-L2 джерела
* **Fallback:** якщо немає L1-L2 → використовуємо L3-L4
* **Останній варіант:** якщо немає жодних → "немає даних"
* **Без рівнів довіри** - не позначаємо яке джерело використано

---

## Обробка помилок

* 429/ліміти API → експоненційний бек‑оф, кеш результатів, контроль розміру контенту.
* Відсутність PDF/HTML → альтернативні дзеркала з тим самим DOI/PMID.

---

## Метрики

* Частка записів з L1/L2, % `needs_human_review`, середній час/інгредієнт, повнота полів.

---

# Google Sheets → Оркестрація пошуку (VS Code)

## Конфіг користувача (надано)

```
SHEET_ID_ING = "1kOrSOPgn7IDdA170YJDRBQw4Wt2-Y8uX0PdvCfxY4qA"
INPUTSHEET = "Ingredients_Main"
INGREDIENTS_RANGE = "C2:C"      # назва
SYNONYMS_RANGE   = "E2:E"      # синоніми (розділювачі: ";" або ",")
FACTSHEET_RANGE  = "G2:G"      # FactsheetLinks (посилання)
RESULTS_SHEET    = "Results_Main"
KINGDOM_RANGE    = "D2:D"       # підказка Kingdom із вхідного аркуша
```

## Мапа стовпчиків Results\_Main (рекомендована)

| Колонка | Поле                  | Опис                                                                                                                           |
| ------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| A       | Ingredient            | сире ім'я з `C`                                                                                                                |
| B       | Taxon\_UK             | нормалізована укр. назва                                                                                                       |
| C       | Taxon\_LAT            | латинська назва                                                                                                                |
| D       | Rank                  | species/genus/other                                                                                                            |
| E       | Kingdom               | Рослини/Тварини/Гриби/Бактерії/Людина/Інше — **джерело: Ingredients\_Main!D2\:D** (якщо заповнено; інакше визначає Normalizer) |
| F       | PartOrOrigin          | "кореневище"/"цілий організм"/…                                                                                                |
| G       | ActiveCompounds\_JSON | JSON масив сполук + evidence                                                                                                   |
| H       | DailyDose\_JSON       | JSON блоку дози                                                                                                                |
| I       | BestSourcePriority    | 1..4 (мінімальне з прийнятих)                                                                                                  |
| J       | EvidenceCount         | кількість evidence (усі поля)                                                                                                  |
| K       | ResultStatus          | complete/partial/no\_data                                                                                                      |
| L       | UA\_Block             | 6‑блоковий текст для людини                                                                                                    |
| M       | SearchTerms           | згенеровані терми (через `; `)                                                                                                 |
| N       | AcceptedURLs          | топ‑посилання (через `; `)                                                                                                     |
| O       | FactsheetUsed         | TRUE/FALSE                                                                                                                     |
| P       | UpdatedAt             | ISO8601 таймштамп                                                                                                              |

---

# Правила розробки та структури коду

## Архітектурні принципи

**ВАЖЛИВО: НЕ СТВОРЮВАТИ НОВІ PYTHON ФАЙЛИ БЕЗ УЗГОДЖЕННЯ**

Система має ФІКСОВАНУ структуру файлів. Всі зміни вносяться тільки в існуючі файли згідно з затвердженою архітектурою:

```
DLSD/
├── main.py                     # CLI інтерфейс - ОСНОВНИЙ ФАЙЛ
├── config.py                   # Конфігурація - НЕ ЗМІНЮВАТИ СТРУКТУРУ
├── auth.py                     # Google Sheets автентифікація
├── requirements.txt            # Залежності
├── modules/                    # AI та основні модулі
│   ├── __init__.py
│   ├── multi_ai_client.py     # Multi-AI інтеграція (OpenAI, Claude, Gemini)
│   ├── search.py              # PubMed та пошук джерел
│   └── processors.py          # Batch обробка та експорт
├── processes/                  # 9-етапний науковий пайплайн
│   ├── __init__.py
│   ├── schemas.py             # JSON Schema валідації
│   ├── source_policy.py       # L1-L4 політика джерел
│   ├── normalizer.py          # Stage 0: Нормалізація
│   ├── searcher.py            # Stage 1: Пошук кандидатів
│   ├── judge.py               # Stage 2: Рангування джерел
│   ├── extractor.py           # Stage 4: Витягування даних
│   ├── validator.py           # Stage 5: Валідація
│   └── formatter.py           # Stage 7: UA форматування
└── output/                     # Результати
```

## Правила внесення змін

1. **Функціональність додається в ІСНУЮЧІ модулі**
2. **Нові процеси (agents) додаються тільки в `processes/`**
3. **Загальна логіка оновлюється в `modules/`**
4. **CLI команди розширюються в `main.py`**
5. **Конфігурація оновлюється в `config.py`**

## Затверджена функціональна мапа

### `main.py` - Точка входу
- CLI команди: setup, test, process, export
- Оркестрація 9-етапного пайплайну
- Інтеграція з Google Sheets

### `modules/multi_ai_client.py` - AI ядро
- OpenAI, Claude, Gemini клієнти
- Автоматичний fallback між моделями
- Системні промпти для наукової валідації

### `processes/` - Наукові агенти
- Кожен файл = один етап пайплайну
- JSON Schema валідація
- Жорстка політика джерел L1-L4

### `config.py` - Централізована конфігурація
- API ключі та моделі
- Google Sheets мапінг
- Рівні довіри джерел

## Заборонені дії

❌ **НЕ створювати нові .py файли без обговорення**
❌ **НЕ змінювати структуру директорій**
❌ **НЕ дублювати функціональність між модулями**
❌ **НЕ порушувати принцип єдиної відповідальності**

✅ **Тільки розширення існуючих модулів**
✅ **Додавання методів до існуючих класів**
✅ **Оновлення конфігурацій**
✅ **Покращення існуючої логіки**

---

## Універсальний словник `PartOrOrigin`

Рекомендовані значення (необмежувальний список):

* **Рослинне**: кореневище; корінь; листя; надземні частини; кора; насіння; плоди; квіти; екстракт (вказати розчинник, якщо є у джерелі).
* **Тваринне**: цілий організм; тканини/екстракт тканин; шкаралупа/панцир/кістки; олія/жир; колаген/желатин.
* **Мікробне**: культура мікроорганізмів; мікробна ферментація; ліофілізовані клітини; метаболіти/постбіотики.
* **Синтетичне/біотехнологічне**: хімічний синтез; біотехнологічний синтез; синтетичного походження.
* **Людського походження**: людського походження (використовувати лише за наявності чітких регуляторних/наукових підстав у джерелах).

> Всі нетривіальні значення мають бути підкріплені цитатою та URL L1–L3.